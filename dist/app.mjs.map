{"version":3,"file":"app.mjs","sources":["../src/app.ts"],"sourcesContent":["import { NOOP } from './const'\nimport type { Display } from './object/display'\nimport type { RenderImpl } from './types'\nimport { formatValue } from './utils'\n\ninterface AppConstructorOptions {\n  width?: number\n  height?: number\n  dpr?: boolean\n  onUpdate?: () => void\n}\n\nexport class App {\n  canvas: HTMLCanvasElement\n  ctx: CanvasRenderingContext2D\n  dpr = 1\n  width: number\n  height: number\n  onUpdate: () => void\n  constructor(\n    {\n    width = 600,\n    height = 800,\n    dpr = true,\n    onUpdate,\n  }: AppConstructorOptions = {},\n  ) {\n    if (dpr) {\n      this.dpr = window.devicePixelRatio ?? 1\n    }\n    this.onUpdate = onUpdate ?? NOOP\n    this.canvas = document.createElement('canvas')!\n    this.ctx = this.canvas.getContext('2d')!\n    this.canvas.style.width = formatValue(width)\n    this.canvas.style.height = formatValue(height)\n    this.canvas.width = width * this.dpr\n    this.canvas.height = height * this.dpr\n    this.ctx.scale(this.dpr, this.dpr)\n    this.width = width\n    this.height = height\n    this.debug()\n    this.update()\n  }\n\n  private beforeRender() {\n    this.ctx.save()\n  }\n\n  private afterRender() {\n    this.ctx.restore()\n  }\n\n  private debug() {\n    const ctx = this.ctx\n    this.ctx.strokeStyle = '#00ffcc'\n    this.beforeRender()\n    ctx.textBaseline = 'top'\n    ctx.font = '12px 黑体'\n    for (let row = 0; row < Math.ceil((this.width + 1) / 100); row++) {\n      for (let col = 0; col < Math.ceil((this.height + 1) / 100); col++) {\n        ctx.beginPath()\n        ctx.fillText(`${row * 100},${col * 100}`, row * 100, col * 100)\n        if (row === 0 || col === 0) {\n          continue\n        }\n        ctx.moveTo(row * 100 - 100, col * 100)\n        ctx.lineTo(row * 100, col * 100)\n        ctx.lineTo(row * 100, col * 100 - 100)\n        ctx.stroke()\n      }\n    }\n    this.afterRender()\n  }\n\n  children: Display[] = []\n\n  add(object: Display) {\n    console.log(object)\n    object.onAdd()\n    this.children.push(object)\n  }\n\n  remove(object: Display) {\n    const index = this.children.indexOf(object)\n    if (index !== -1) {\n      this.children.splice(index, 1)\n    }\n  }\n\n  private update() {\n    window.requestAnimationFrame(() => {\n      this.update()\n    })\n    this.ctx.clearRect(\n      -this.width,\n      -this.height,\n      this.width * 2,\n      this.height * 2,\n    )\n\n    this.debug()\n    const children = [...this.children.filter(e => e.visible)]\n    while (children.length) {\n      this.beforeRender()\n      children.shift()?.render(this.ctx)\n      this.afterRender()\n    }\n    this.onUpdate()\n  }\n}\n"],"names":["App","canvas","ctx","dpr","width","height","onUpdate","constructor","this","window","devicePixelRatio","NOOP","document","createElement","getContext","style","formatValue","scale","debug","update","beforeRender","save","afterRender","restore","strokeStyle","textBaseline","font","row","Math","ceil","col","beginPath","fillText","moveTo","lineTo","stroke","children","add","object","console","log","onAdd","push","remove","index","indexOf","splice","requestAnimationFrame","clearRect","filter","e","visible","length","shift","render"],"mappings":"mFAYaA,EACXC,OACAC,IACAC,IAAM,EACNC,MACAC,OACAC,SACA,WAAAC,EACEH,MACAA,EAAQ,IAAGC,OACXA,EAAS,IAAGF,IACZA,GAAM,EAAIG,SACVA,GACyB,IAErBH,IACFK,KAAKL,IAAMM,OAAOC,kBAAoB,GAExCF,KAAKF,SAAWA,GAAYK,EAC5BH,KAAKP,OAASW,SAASC,cAAc,UACrCL,KAAKN,IAAMM,KAAKP,OAAOa,WAAW,MAClCN,KAAKP,OAAOc,MAAMX,MAAQY,EAAYZ,GACtCI,KAAKP,OAAOc,MAAMV,OAASW,EAAYX,GACvCG,KAAKP,OAAOG,MAAQA,EAAQI,KAAKL,IACjCK,KAAKP,OAAOI,OAASA,EAASG,KAAKL,IACnCK,KAAKN,IAAIe,MAAMT,KAAKL,IAAKK,KAAKL,KAC9BK,KAAKJ,MAAQA,EACbI,KAAKH,OAASA,EACdG,KAAKU,QACLV,KAAKW,QACN,CAEO,YAAAC,GACNZ,KAAKN,IAAImB,MACV,CAEO,WAAAC,GACNd,KAAKN,IAAIqB,SACV,CAEO,KAAAL,GACN,MAAMhB,EAAMM,KAAKN,IACjBM,KAAKN,IAAIsB,YAAc,UACvBhB,KAAKY,eACLlB,EAAIuB,aAAe,MACnBvB,EAAIwB,KAAO,UACX,IAAK,IAAIC,EAAM,EAAGA,EAAMC,KAAKC,MAAMrB,KAAKJ,MAAQ,GAAK,KAAMuB,IACzD,IAAK,IAAIG,EAAM,EAAGA,EAAMF,KAAKC,MAAMrB,KAAKH,OAAS,GAAK,KAAMyB,IAC1D5B,EAAI6B,YACJ7B,EAAI8B,SAAS,GAAS,IAANL,KAAmB,IAANG,IAAmB,IAANH,EAAiB,IAANG,GACzC,IAARH,GAAqB,IAARG,IAGjB5B,EAAI+B,OAAa,IAANN,EAAY,IAAW,IAANG,GAC5B5B,EAAIgC,OAAa,IAANP,EAAiB,IAANG,GACtB5B,EAAIgC,OAAa,IAANP,EAAiB,IAANG,EAAY,KAClC5B,EAAIiC,UAGR3B,KAAKc,aACN,CAEDc,SAAsB,GAEtB,GAAAC,CAAIC,GACFC,QAAQC,IAAIF,GACZA,EAAOG,QACPjC,KAAK4B,SAASM,KAAKJ,EACpB,CAED,MAAAK,CAAOL,GACL,MAAMM,EAAQpC,KAAK4B,SAASS,QAAQP,IACrB,IAAXM,GACFpC,KAAK4B,SAASU,OAAOF,EAAO,EAE/B,CAEO,MAAAzB,GACNV,OAAOsC,uBAAsB,KAC3BvC,KAAKW,QAAQ,IAEfX,KAAKN,IAAI8C,WACNxC,KAAKJ,OACLI,KAAKH,OACO,EAAbG,KAAKJ,MACS,EAAdI,KAAKH,QAGPG,KAAKU,QACL,MAAMkB,EAAW,IAAI5B,KAAK4B,SAASa,QAAOC,GAAKA,EAAEC,WACjD,KAAOf,EAASgB,QACd5C,KAAKY,eACLgB,EAASiB,SAASC,OAAO9C,KAAKN,KAC9BM,KAAKc,cAEPd,KAAKF,UACN"}