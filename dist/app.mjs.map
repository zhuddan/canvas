{"version":3,"file":"app.mjs","sources":["../src/app.ts"],"sourcesContent":["import EventEmitter from 'eventemitter3'\nimport { NOOP } from './const'\nimport type { Display } from './object/display'\nimport { formatValue } from './utils'\n\ninterface AppConstructorOptions {\n  width?: number\n  height?: number\n  dpr?: boolean\n  onUpdate?: () => void\n  createImage?: () => HTMLImageElement\n}\n\nexport class App extends EventEmitter<{\n  render: []\n}> {\n  canvas: HTMLCanvasElement\n  ctx: CanvasRenderingContext2D\n  dpr = 1\n  width: number\n  height: number\n  onUpdate: () => void\n  static createImage: () => HTMLImageElement\n  constructor({\n    width = 600,\n    height = 800,\n    dpr = true,\n    createImage = () => document.createElement('img'),\n    onUpdate,\n  }: AppConstructorOptions = {},\n  ) {\n    super()\n    if (dpr) {\n      this.dpr = window.devicePixelRatio ?? 1\n    }\n    // this.dpr = 1\n    this.onUpdate = onUpdate ?? NOOP\n    this.canvas = document.createElement('canvas')!\n    this.ctx = this.canvas.getContext('2d')!\n    this.canvas.style.width = formatValue(width)\n    this.canvas.style.height = formatValue(height)\n    this.canvas.width = width * this.dpr\n    this.canvas.height = height * this.dpr\n    this.width = width\n    this.height = height\n    App.createImage = createImage\n    this.update()\n  }\n\n  private beforeRender() {\n    this.ctx.save()\n  }\n\n  private afterRender() {\n    this.ctx.restore()\n  }\n\n  // private debug() {\n  //   this.beforeRender()\n  //   const ctx = this.ctx\n  //   this.ctx.strokeStyle = '#cccccc'\n  //   this.ctx.fillStyle = '#cccccc'\n  //   ctx.textBaseline = 'top'\n  //   ctx.font = '10px 黑体'\n  //   ctx.setLineDash([4, 10])\n  //   for (let row = 0; row < Math.ceil((this.width + 1) / 100); row++) {\n  //     for (let col = 0; col < Math.ceil((this.height + 1) / 100); col++) {\n  //       ctx.beginPath()\n  //       ctx.fillText(`${row * 100},${col * 100}`, row * 100 * this.dpr, col * 100 * this.dpr)\n  //       if (row === 0 || col === 0) {\n  //         continue\n  //       }\n  //       ctx.moveTo((row * 100 - 100) * this.dpr, col * 100 * this.dpr)\n  //       ctx.lineTo(row * 100 * this.dpr, col * 100 * this.dpr)\n  //       ctx.lineTo(row * 100 * this.dpr, (col * 100 - 100) * this.dpr)\n  //       ctx.stroke()\n  //     }\n  //   }\n  //   this.afterRender()\n  // }\n\n  children: Display[] = []\n\n  add(object: Display) {\n    this.children.push(object)\n    object.onAdd(this)\n  }\n\n  remove(object: Display) {\n    const index = this.children.indexOf(object)\n    if (index !== -1) {\n      object.onRemove()\n      this.children.splice(index, 1)\n    }\n  }\n\n  private update() {\n    window.requestAnimationFrame(() => {\n      this.update()\n    })\n\n    if (!this.children.length) {\n      return\n    }\n\n    const isDirty = !![...this.children.filter(e => e.dirty)].length\n    const _renderIds = this.children.every(e => e._renderId > 0)\n    if (_renderIds && this.children.length) {\n      this.emit('render')\n    }\n    if (!isDirty)\n      return\n    this.ctx.clearRect(\n      -this.canvas.width,\n      -this.canvas.height,\n      this.canvas.width * 2,\n      this.canvas.height * 2,\n    )\n\n    // this.debug()\n    const shouldRender = [...this.children].filter(e => e.shouldUpdate)\n    while (shouldRender.length) {\n      this.beforeRender()\n      const child = shouldRender.shift()!\n      child.render(this.ctx)\n      child.dirty = false\n      child._renderId++\n      this.afterRender()\n    }\n\n    this.onUpdate()\n  }\n\n  toDataURL(type?: string, quality?: any) {\n    return this.canvas.toDataURL(type, quality)\n  }\n\n  toDataURLAsync(type?: string, quality?: any) {\n    return new Promise<string>((resolve) => {\n      this.once('render', () => {\n        resolve(this.toDataURL(type, quality))\n      })\n    })\n  }\n\n  onContext(fn: (ctx: CanvasRenderingContext2D) => any) {\n    this.beforeRender()\n    fn(this.ctx)\n    this.afterRender()\n  }\n}\n"],"names":["App","EventEmitter","canvas","ctx","dpr","width","height","onUpdate","static","constructor","createImage","document","createElement","super","this","window","devicePixelRatio","NOOP","getContext","style","formatValue","update","beforeRender","save","afterRender","restore","children","add","object","push","onAdd","remove","index","indexOf","onRemove","splice","requestAnimationFrame","length","isDirty","filter","e","dirty","every","_renderId","emit","clearRect","shouldRender","shouldUpdate","child","shift","render","toDataURL","type","quality","toDataURLAsync","Promise","resolve","once","onContext","fn"],"mappings":"qHAaM,MAAOA,UAAYC,EAGvBC,OACAC,IACAC,IAAM,EACNC,MACAC,OACAC,SACAC,mBACA,WAAAC,EAAYJ,MACVA,EAAQ,IAAGC,OACXA,EAAS,IAAGF,IACZA,GAAM,EAAIM,YACVA,EAAc,IAAMC,SAASC,cAAc,OAAML,SACjDA,GACyB,IAEzBM,QACIT,IACFU,KAAKV,IAAMW,OAAOC,kBAAoB,GAGxCF,KAAKP,SAAWA,GAAYU,EAC5BH,KAAKZ,OAASS,SAASC,cAAc,UACrCE,KAAKX,IAAMW,KAAKZ,OAAOgB,WAAW,MAClCJ,KAAKZ,OAAOiB,MAAMd,MAAQe,EAAYf,GACtCS,KAAKZ,OAAOiB,MAAMb,OAASc,EAAYd,GACvCQ,KAAKZ,OAAOG,MAAQA,EAAQS,KAAKV,IACjCU,KAAKZ,OAAOI,OAASA,EAASQ,KAAKV,IACnCU,KAAKT,MAAQA,EACbS,KAAKR,OAASA,EACdN,EAAIU,YAAcA,EAClBI,KAAKO,QACN,CAEO,YAAAC,GACNR,KAAKX,IAAIoB,MACV,CAEO,WAAAC,GACNV,KAAKX,IAAIsB,SACV,CA0BDC,SAAsB,GAEtB,GAAAC,CAAIC,GACFd,KAAKY,SAASG,KAAKD,GACnBA,EAAOE,MAAMhB,KACd,CAED,MAAAiB,CAAOH,GACL,MAAMI,EAAQlB,KAAKY,SAASO,QAAQL,IACrB,IAAXI,IACFJ,EAAOM,WACPpB,KAAKY,SAASS,OAAOH,EAAO,GAE/B,CAEO,MAAAX,GAKN,GAJAN,OAAOqB,uBAAsB,KAC3BtB,KAAKO,QAAQ,KAGVP,KAAKY,SAASW,OACjB,OAGF,MAAMC,IAAY,IAAIxB,KAAKY,SAASa,QAAOC,GAAKA,EAAEC,SAAQJ,OAK1D,GAJmBvB,KAAKY,SAASgB,OAAMF,GAAKA,EAAEG,UAAY,KACxC7B,KAAKY,SAASW,QAC9BvB,KAAK8B,KAAK,WAEPN,EACH,OACFxB,KAAKX,IAAI0C,WACN/B,KAAKZ,OAAOG,OACZS,KAAKZ,OAAOI,OACO,EAApBQ,KAAKZ,OAAOG,MACS,EAArBS,KAAKZ,OAAOI,QAId,MAAMwC,EAAe,IAAIhC,KAAKY,UAAUa,QAAOC,GAAKA,EAAEO,eACtD,KAAOD,EAAaT,QAAQ,CAC1BvB,KAAKQ,eACL,MAAM0B,EAAQF,EAAaG,QAC3BD,EAAME,OAAOpC,KAAKX,KAClB6C,EAAMP,OAAQ,EACdO,EAAML,YACN7B,KAAKU,aACN,CAEDV,KAAKP,UACN,CAED,SAAA4C,CAAUC,EAAeC,GACvB,OAAOvC,KAAKZ,OAAOiD,UAAUC,EAAMC,EACpC,CAED,cAAAC,CAAeF,EAAeC,GAC5B,OAAO,IAAIE,SAAiBC,IAC1B1C,KAAK2C,KAAK,UAAU,KAClBD,EAAQ1C,KAAKqC,UAAUC,EAAMC,GAAS,GACtC,GAEL,CAED,SAAAK,CAAUC,GACR7C,KAAKQ,eACLqC,EAAG7C,KAAKX,KACRW,KAAKU,aACN"}