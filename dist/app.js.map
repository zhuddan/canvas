{"version":3,"file":"app.js","sources":["../src/app.ts"],"sourcesContent":["import { NOOP } from './const'\nimport type { Display } from './object/display'\nimport type { RenderImpl } from './types'\nimport { formatValue } from './utils'\n\ninterface AppConstructorOptions {\n  width?: number\n  height?: number\n  dpr?: boolean\n  onUpdate?: () => void\n}\n\nexport class App {\n  canvas: HTMLCanvasElement\n  ctx: CanvasRenderingContext2D\n  dpr = 1\n  width: number\n  height: number\n  onUpdate: () => void\n  constructor(\n    {\n    width = 600,\n    height = 800,\n    dpr = true,\n    onUpdate,\n  }: AppConstructorOptions = {},\n  ) {\n    if (dpr) {\n      this.dpr = window.devicePixelRatio ?? 1\n    }\n    this.onUpdate = onUpdate ?? NOOP\n    this.canvas = document.createElement('canvas')!\n    this.ctx = this.canvas.getContext('2d')!\n    this.canvas.style.width = formatValue(width)\n    this.canvas.style.height = formatValue(height)\n    this.canvas.width = width * this.dpr\n    this.canvas.height = height * this.dpr\n    this.ctx.scale(this.dpr, this.dpr)\n    this.width = width\n    this.height = height\n    this.update()\n  }\n\n  private beforeRender() {\n    this.ctx.save()\n  }\n\n  private afterRender() {\n    this.ctx.restore()\n  }\n\n  private debug() {\n    this.beforeRender()\n    const ctx = this.ctx\n    this.ctx.strokeStyle = '#cccccc80'\n    this.ctx.fillStyle = '#cccccc80'\n    ctx.textBaseline = 'top'\n    ctx.font = '10px 黑体'\n    ctx.setLineDash([4, 10])\n    for (let row = 0; row < Math.ceil((this.width + 1) / 100); row++) {\n      for (let col = 0; col < Math.ceil((this.height + 1) / 100); col++) {\n        ctx.beginPath()\n        ctx.fillText(`${row * 100},${col * 100}`, row * 100, col * 100)\n        if (row === 0 || col === 0) {\n          continue\n        }\n        ctx.moveTo(row * 100 - 100, col * 100)\n        ctx.lineTo(row * 100, col * 100)\n        ctx.lineTo(row * 100, col * 100 - 100)\n        ctx.stroke()\n      }\n    }\n    this.afterRender()\n  }\n\n  children: Display[] = []\n\n  add(object: Display) {\n    object.onAdd()\n    object._app = this\n    this.children.push(object)\n  }\n\n  remove(object: Display) {\n    const index = this.children.indexOf(object)\n    if (index !== -1) {\n      this.children.splice(index, 1)\n      object._app = null\n    }\n  }\n\n  private update() {\n    window.requestAnimationFrame(() => {\n      this.update()\n    })\n\n    const isDirty = !![...this.children.filter(e => e.dirty)].length\n    if (!isDirty)\n      return\n    this.ctx.clearRect(\n      -this.width,\n      -this.height,\n      this.width * 2,\n      this.height * 2,\n    )\n\n    this.debug()\n    const shouldRender = [...this.children].filter(e => e.shouldUpdate)\n    while (shouldRender.length) {\n      this.beforeRender()\n      const child = shouldRender.shift()!\n      child.render(this.ctx)\n      child.dirty = false\n      this.afterRender()\n    }\n    this.onUpdate()\n  }\n\n  onContext(fn: (ctx: CanvasRenderingContext2D) => any) {\n    this.beforeRender()\n    fn(this.ctx)\n    this.afterRender()\n  }\n}\n"],"names":["canvas","ctx","dpr","width","height","onUpdate","constructor","this","window","devicePixelRatio","NOOP","document","createElement","getContext","style","formatValue","scale","update","beforeRender","save","afterRender","restore","debug","strokeStyle","fillStyle","textBaseline","font","setLineDash","row","Math","ceil","col","beginPath","fillText","moveTo","lineTo","stroke","children","add","object","onAdd","_app","push","remove","index","indexOf","splice","requestAnimationFrame","filter","e","dirty","length","clearRect","shouldRender","shouldUpdate","child","shift","render","onContext","fn"],"mappings":"mFAaEA,OACAC,IACAC,IAAM,EACNC,MACAC,OACAC,SACA,WAAAC,EACEH,MACAA,EAAQ,IAAGC,OACXA,EAAS,IAAGF,IACZA,GAAM,EAAIG,SACVA,GACyB,IAErBH,IACFK,KAAKL,IAAMM,OAAOC,kBAAoB,GAExCF,KAAKF,SAAWA,GAAYK,OAC5BH,KAAKP,OAASW,SAASC,cAAc,UACrCL,KAAKN,IAAMM,KAAKP,OAAOa,WAAW,MAClCN,KAAKP,OAAOc,MAAMX,MAAQY,EAAWA,YAACZ,GACtCI,KAAKP,OAAOc,MAAMV,OAASW,EAAWA,YAACX,GACvCG,KAAKP,OAAOG,MAAQA,EAAQI,KAAKL,IACjCK,KAAKP,OAAOI,OAASA,EAASG,KAAKL,IACnCK,KAAKN,IAAIe,MAAMT,KAAKL,IAAKK,KAAKL,KAC9BK,KAAKJ,MAAQA,EACbI,KAAKH,OAASA,EACdG,KAAKU,QACN,CAEO,YAAAC,GACNX,KAAKN,IAAIkB,MACV,CAEO,WAAAC,GACNb,KAAKN,IAAIoB,SACV,CAEO,KAAAC,GACNf,KAAKW,eACL,MAAMjB,EAAMM,KAAKN,IACjBM,KAAKN,IAAIsB,YAAc,YACvBhB,KAAKN,IAAIuB,UAAY,YACrBvB,EAAIwB,aAAe,MACnBxB,EAAIyB,KAAO,UACXzB,EAAI0B,YAAY,CAAC,EAAG,KACpB,IAAK,IAAIC,EAAM,EAAGA,EAAMC,KAAKC,MAAMvB,KAAKJ,MAAQ,GAAK,KAAMyB,IACzD,IAAK,IAAIG,EAAM,EAAGA,EAAMF,KAAKC,MAAMvB,KAAKH,OAAS,GAAK,KAAM2B,IAC1D9B,EAAI+B,YACJ/B,EAAIgC,SAAS,GAAS,IAANL,KAAmB,IAANG,IAAmB,IAANH,EAAiB,IAANG,GACzC,IAARH,GAAqB,IAARG,IAGjB9B,EAAIiC,OAAa,IAANN,EAAY,IAAW,IAANG,GAC5B9B,EAAIkC,OAAa,IAANP,EAAiB,IAANG,GACtB9B,EAAIkC,OAAa,IAANP,EAAiB,IAANG,EAAY,KAClC9B,EAAImC,UAGR7B,KAAKa,aACN,CAEDiB,SAAsB,GAEtB,GAAAC,CAAIC,GACFA,EAAOC,QACPD,EAAOE,KAAOlC,KACdA,KAAK8B,SAASK,KAAKH,EACpB,CAED,MAAAI,CAAOJ,GACL,MAAMK,EAAQrC,KAAK8B,SAASQ,QAAQN,IACrB,IAAXK,IACFrC,KAAK8B,SAASS,OAAOF,EAAO,GAC5BL,EAAOE,KAAO,KAEjB,CAEO,MAAAxB,GACNT,OAAOuC,uBAAsB,KAC3BxC,KAAKU,QAAQ,IAIf,MADkB,IAAIV,KAAK8B,SAASW,QAAOC,GAAKA,EAAEC,SAAQC,OAExD,OACF5C,KAAKN,IAAImD,WACN7C,KAAKJ,OACLI,KAAKH,OACO,EAAbG,KAAKJ,MACS,EAAdI,KAAKH,QAGPG,KAAKe,QACL,MAAM+B,EAAe,IAAI9C,KAAK8B,UAAUW,QAAOC,GAAKA,EAAEK,eACtD,KAAOD,EAAaF,QAAQ,CAC1B5C,KAAKW,eACL,MAAMqC,EAAQF,EAAaG,QAC3BD,EAAME,OAAOlD,KAAKN,KAClBsD,EAAML,OAAQ,EACd3C,KAAKa,aACN,CACDb,KAAKF,UACN,CAED,SAAAqD,CAAUC,GACRpD,KAAKW,eACLyC,EAAGpD,KAAKN,KACRM,KAAKa,aACN"}